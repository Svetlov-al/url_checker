# FastAPI + MariaDB URL Saver

## Зависимости

Для работы проекта используются следующие зависимости:

### Основные библиотеки

- **Python**: `^3.11` — версия Python 3.11 и выше.
- **FastAPI**: `^0.115.2` — веб-фреймворк для создания API.
- **Uvicorn**: `^0.31.1` — ASGI сервер для запуска приложений на FastAPI.
- **Pydantic Settings**: `^2.5.2` — библиотека для управления настройками с использованием Pydantic.
- **SQLAlchemy**: `^2.0.35` — ORM для работы с базами данных.
- **Alembic**: `^1.13.3` — инструмент для миграции базы данных, работающий с SQLAlchemy.

### Для работы с окружением

- **Python-dotenv**: `^1.0.1` — загрузка переменных окружения из `.env` файла.
- **ORJSON**: `^3.10.7` — высокая производительность при сериализации и десериализации JSON.
- **HTTPX**: `^0.27.2` — асинхронная библиотека для HTTP-запросов.

### Очереди и задачи

- **Celery**: `^5.4.0` — фреймворк для распределенной обработки задач.
- **Redis**: `^5.1.1` — хранилище данных в памяти, используемое для очередей.
- **Flower**: `^2.0.1` — инструмент мониторинга для Celery.

### Прочее

- **Dependency Injector**: `^4.42.0` — контейнер для внедрения зависимостей.
- **IPython**: `^8.28.0` — интерактивная оболочка для Python.
- **SQLAdmin**: `^0.19.0` — административный интерфейс для SQLAlchemy с полным набором возможностей.
- **AsyncMy**: `^0.2.9` — асинхронный драйвер для MySQL.
- **PyMySQL**: `^1.1.1` — библиотека для работы с MySQL.

### Контейнеризация

- **python:3.11.5-slim-bullseye** — базовый образ Docker для создания контейнера с Python.


- [Docker](https://www.docker.com/get-started)
- [Docker Compose](https://docs.docker.com/compose/install/)
- [GNU Make](https://www.gnu.org/software/make/)

## Как использовать

**Клонируем репозиторий:**

   ```bash
   git clone https://github.com/your_username/your_repository.git
   cd your_repository
```

### Подготовка переменных окружения
Создать `.env` файл из `.env.example`

```
cp .env.example .env
```


### Команды запуска

* `make up` - Поднять приложение и базу данных
* `make down` - Остановить приложение и базу данных
* 
* `make app-dev` - Поднять приложение
* `make down-dev` - Остановить приложение


* `make storage` - Поднять базу данных
* `make storage-down` - Остановить базу данных


* `make app-dev-logs` - Смотреть логи приложения


* `make shell` - Войти в контейнер shell (bash)


* `make upgrade` - Применить миграции


* `make celery` - Поднять Celery/Flower/Redis для асинхронных задач
* `make celery-down` - Остановить контейнеры Celery/Flower/Redis


## Использование

### 1. Настройка ключей API

Для работы с проверками через `virus_total` и `abusive_experience` необходимо добавить соответствующие ключи в админ-панель:

1. Перейдите в админ-панель по адресу `/admin`.
2. Найдите раздел для добавления ключей API для `virus_total` и `abusive_experience`.
3. Убедитесь, что ключи для каждого из API добавлены и сохранены.

### 2. Конфигурация прокси (по желанию)

Если требуется использовать прокси-сервер для запросов к API, вы можете указать его в настройках. Прокси будет автоматически использоваться при обращении к API для проверки ссылок.

### 3. Обработка ссылок

- Все ссылки, которые нуждаются в проверке, попадают в очередь Redis (FIFO).
- После этого, с использованием Celery, запускаются асинхронные задачи:
  - `vt_validate` — для проверки через `virus_total`.
  - `ae_validate` — для проверки через `abusive_experience`.

Задачи будут автоматически извлекать ссылки из очереди и отправлять их на проверку в соответствующие API.

### 4. Результаты обработки

- После завершения обработки каждая ссылка будет иметь результат в модели `Result`.
- Результаты обработки сохраняются в базе данных, где хранятся значения для каждого поля, связанного с проверками в базе данных, где хранятся значения для каждого поля, связанного с проверками.

TODO 
Добавить заголовки рандомайзер